<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Volt Chat Bot</title>

  <meta charset="utf-8" />
  <link rel="icon" href="/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="white" media="(prefers-color-scheme: dark)" />
  <meta name="background-color" content="white" media="(prefers-color-scheme: dark)" />

  <link rel="apple-touch-icon" href="/volt-logo-white-192.png" />
  <link rel="manifest" href="/manifest.json" />

  <script async defer data-website-id="81c67243-c55c-476c-ada6-a9d97324d731" src="https://umami.volteuropa.org/umami.js" data-domains="chat.volt.link"></script>

  <style>
    :root {
      --purple-lighter: #e6ccff;
      --purple-light: #b58dd9;
      --purple: #502379;
      --purple-dark: #19022d;
      --purple-darker: #0d0019;

      --purple-light-rgb: 181, 141, 217;
      --purple-rgb: 80, 35, 121;

      --green-lighter: #d1ffe9;
      --green-light: #94fcc9;
      --green: #1bbe6f;
      --green-dark: #005029;
      --green-darker: #00190d;

      --red-lighter: #ffd6cc;
      --red-light: #ffad93;
      --red: #e63e12;
      --red-dark: #641400;
      --red-darker: #190500;

      --yellow-lighter: #fff1cc;
      --yellow-light: #ffe787;
      --yellow: #fdc220;
      --yellow-dark: #926f0d;
      --yellow-darker: #191300;

      --blue-lighter: #dff5ff;
      --blue-light: #c3f1ff;
      --blue: #82d0f4;
      --blue-dark: #30708e;
      --blue-darker: #031219;

      --gray-lighter: #ffffff;
      --gray-light: #edecee;
      --gray: #c2bfc4;
      --gray-dark: #726f76;
      --gray-darker: #181719;

      --gray-lighter-rgb: 255,255,255;

      --on-purple-lighter: var(--purple-darker);
      --on-purple-light: var(--purple-darker);
      --on-purple: var(--gray-lighter);
      --on-purple-dark: var(--gray-lighter);
      --on-purple-darker: var(--gray-lighter);

      --on-green-lighter: var(--green-darker);
      --on-green-light: var(--green-darker);
      --on-green: var(--gray-lighter);
      --on-green-dark: var(--gray-lighter);
      --on-green-darker: var(--gray-lighter);

      --on-red-lighter: var(--red-darker);
      --on-red-light: var(--red-darker);
      --on-red: var(--gray-lighter);
      --on-red-dark: var(--gray-lighter);
      --on-red-darker: var(--gray-lighter);

      --on-yellow-lighter: var(--yellow-darker);
      --on-yellow-light: var(--yellow-darker);
      --on-yellow: var(--yellow-darker);
      --on-yellow-dark: var(--gray-lighter);
      --on-yellow-darker: var(--gray-lighter);

      --on-blue-lighter: var(--blue-darker);
      --on-blue-light: var(--blue-darker);
      --on-blue: var(--blue-darker);
      --on-blue-dark: var(--gray-lighter);
      --on-blue-darker: var(--gray-lighter);

      --on-gray-lighter: var(--gray-darker);
      --on-gray-light: var(--gray-darker);
      --on-gray: var(--gray-darker);
      --on-gray-dark: var(--gray-lighter);
      --on-gray-darker: var(--gray-lighter);

      --alpha-more: 0.8;
      --alpha: 0.6;
      --alpha-less: 0.2;

      --blur: 20px;

      --timing: .2s ease-in-out;

      --font-family: 'Ubuntu', 'Noto Kufi Arabic', 'Geeza Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      --font-family-code: 'Ubuntu Mono', 'Noto Kufi Arabic', 'Geeza Pro', 'Courier New', Courier, monospace;

      --basis_x0_5: 2.5px;
      --basis: 5px;
      --basis_x2: 10px;
      --basis_x4: 20px;
      --basis_x8: 40px;
      --basis_x16: 80px;
      --basis_x32: 160px;

      --shadow-color-rgba: rgba(var(--purple-rgb), 0.2);
    }

    :root {
      --font-family-website-title: var(--font-family);
      --font-family-headline: var(--font-family);
      --font-family-text: var(--font-family);
      --font-family-button: var(--font-family);
    }

    .chatbot_styles * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    .chatbot_styles .chatbot_center {
      max-width: 100%;
      padding: 20px;
      margin: 0 auto;
      --backgound: var(--purple);
      --text: var(--on-purple);
      background: var(--backgound);
      color: var(--text);
      border-radius: 20px 20px 20px 0;

      width: 100%;
    }
    @media (min-width: 700px) {
      .chatbot_styles .chatbot_center {
        width: 600px;
      }
    }

    .chatbot_styles .chatbot {
      background-size: 1200px auto;
      background-position: 50% -50px;
      background-repeat: no-repeat;
      background-color: rgba(var(--purple-rgb), 0.1);
      border-radius: 20px;
      margin: 20px 0;

      background-image: none;
      padding: 0;
    }
    @media (min-width: 700px) {
      .chatbot_styles .chatbot {
        background-image: url("https://chat.volt.link/AI%20Pattern%20Background%20Pi-Shading%20Colorful%201200w.png");
        padding: 20px;
      }
    }

    .chatbot_styles h1 {
      font-family: var(--font-family-website-title);
      font-weight: bold;
      font-size: 60px;
      letter-spacing: -1.5px;
      line-height: 1.1;
      margin-block-end: 2rem;
    }

    @media (max-width: 700px) {
      .chatbot_styles h1 {
        font-size: 40px;
      }
    }

    .chatbot_styles,
    .chatbot_styles p {
      font-family: var(--font-family-text);
      font-weight: normal;
      font-size: 18px;
      letter-spacing: 0.5px;
      line-height: 1.2;
    }
    .chatbot_styles p {
      margin-block-end: 1rem;
    }
    .chatbot_styles .caption {
      font-size: 14px;
      margin: 0;
      color: currentColor;
      opacity: 0.6;
    }

    .chatbot_styles code {
      font-family: var(--font-family-code);
      font-size: 19px;
      white-space: break-spaces;
    }

    .chatbot_styles hr {
      margin-block: 20px;
      color: var(--purple);
      border-style: solid;
    }

    .chatbot_styles textarea,
    .chatbot_styles input[type="text"] {
      appearance: none;
      width: 100%;
      padding: 15px;
      resize: vertical;
      font-family: inherit;
      font-size: inherit;
      color: inherit;
      border-radius: 0;
      border: none;
      outline: none;
      background: var(--background);
      box-shadow: inset 0 0 0 1px var(--text);
      transition: box-shadow 0.2s ease;
    }
    .chatbot_styles textarea {
      min-height: 80px;
    }

    .chatbot_styles textarea:hover {
      box-shadow: inset 0 0 0 2px var(--text);
    }

    .chatbot_styles textarea:focus {
      box-shadow: inset 0 0 0 5px var(--text);
    }

    .chatbot_styles button {
      display: inline-flex;

      font-family: var(--font-family-button);
      text-decoration: none;

      font-weight: inherit;
      font-size: inherit;
      letter-spacing: inherit;

      /* text-transform: uppercase; */
      border: 0;
      font-weight: bold;
      cursor: pointer;

      padding: 10px 20px;
      border-radius: 0;
      font-weight: bold;
      box-shadow: 0 0 0 0 var(--on-purple);
      transition: box-shadow 0.2s ease;
    }

    .chatbot_styles button {
      color: var(--text-color);
      fill: var(--text-color);
      background: var(--background-color);
    }

    .chatbot_styles button svg {
      height: 20px;
      width: auto;
    }

    .chatbot_styles button.text {
      color: var(--background-color);
      fill: var(--background-color);
      /* background: var(--text-color); */
      background: transparent;
    }

    .chatbot_styles button {
      --background-color: var(--on-purple);
      --text-color: var(--purple);
    }
    .chatbot_styles .popup button {
      --background-color: var(--purple);
      --text-color: var(--on-purple);
    }

    /* 
    .chatbot_styles button.gray {
      --background-color: var(--gray);
      --text-color: var(--on-gray);
    }
    */

    .chatbot_styles button.purple {
      --background-color: var(--purple);
      --text-color: var(--on-purple);
    }

    .chatbot_styles button.red {
      --background-color: var(--red);
      --text-color: var(--on-red);
    }

    .chatbot_styles button.blue {
      --background-color: var(--blue-dark);
      --text-color: var(--on-blue-dark);
    }

    .chatbot_styles button.green {
      --background-color: var(--green);
      --text-color: var(--on-green);
    }

    .chatbot_styles button.yellow {
      --background-color: var(--yellow-dark);
      --text-color: var(--on-yellow-dark);
    }

    .chatbot_styles button.small {
      padding: 5px 10px;
      font-size: 14px;
    }

    .chatbot_styles button[data-selected="true"] {
      box-shadow: 0 0 0 2px var(--background-color);
    }

    .chatbot_styles button:not(:disabled):hover {
      box-shadow: 0 0 0 2px var(--background-color);
      text-decoration: none;
    }

    .chatbot_styles button.small:not(:disabled):hover {
      box-shadow: 0 0 0 2px var(--background-color);
    }

    .chatbot_styles button:not(:disabled):active,
    .chatbot_styles button:not(:disabled):focus,
    .chatbot_styles button:not(:disabled).active,
    .chatbot_styles a.active button:not(:disabled) {
      box-shadow: 0 0 0 0 var(--background-color);
      text-decoration: none;
    }

    .chatbot_styles a {
      text-decoration: underline;
      color: inherit;
    }
    .chatbot_styles a:hover,
    .chatbot_styles a:active,
    .chatbot_styles a:focus,
    .chatbot_styles a:visited {
      text-decoration: double underline;
      color: inherit;
    }


    .chatbot_styles button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .chatbot_styles .messages {
      display: flex;
      flex-direction: column;
    }
    .chatbot_styles .chatbubble {
      position: relative;
      display: inline-flex;
      flex-direction: row;
      gap: 10px;
    }
    .chatbot_styles .chatbubble.user {
      flex-direction: row-reverse;
    }
    .chatbot_styles .chatbubble .content {
      padding: 10px;
      margin-block-end: 2px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .chatbot_styles .chatbubble.user + .chatbubble.assistant .content,
    .chatbot_styles .chatbubble.assistant + .chatbubble.user .content {
      margin-block-end: 10px;
    }
    .chatbot_styles .chatbubble .actions {
      display: flex;
      align-items: flex-start;
      align-content: flex-start;
    }
    @media (max-width: 500px) {
      .chatbot_styles .chatbubble .actions {
        flex-wrap: wrap;
      }
    }
    .chatbot_styles .chatbubble.assistant .content {
      align-self: flex-start;
      background: var(--gray-lighter);
      color: var(--purple);
      /* padding: 0; */
      border-radius: 10px 10px 10px 0;
    }
    .chatbot_styles .chatbubble.assistant.error {
      color: var(--red);
    }
    .chatbot_styles .chatbubble.user .content {
      align-self: flex-end;
      background: var(--purple);
      color: var(--on-purple);
      border-radius: 10px 10px 0 10px;
    }
    .chatbot_styles .chatbubble.user.error {
      background: var(--red);
      color: var(--on-red);
    }
    .chatbot_styles .chatbubble p {
      margin: 0;
      color: inherit;
    }

    .chatbot_styles .chatbubble.user + .chatbubble.user .content,
    .chatbot_styles .chatbubble.assistant + .chatbubble.assistant .content {
      border-radius: 0px 10px 10px 0;
    }

    .chatbot_styles .input_box {
      display: flex;
      flex-direction: column;
      align-items: end;
    }

    .chatbot_styles .bot_loading {
      opacity: 0;
      transition-delay: 0s;
      transition: opacity 0s ease;
    }
    .chatbot_styles .bot_loading.active {
      opacity: 1;
      transition-delay: 1s;
      transition: opacity 1s ease;
    }
    .chatbot_styles .bot_loading p.caption {
      color: currentColor;
    }

    .chatbot_styles li {
      margin-inline-start: 20px;
    }

    .chatbot_styles .popup {
      z-index: 1;
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      pointer-events: none;

      --background: var(--on-purple);
      --text: var(--purple);
    }

    .chatbot_styles .popup.open {
      pointer-events: auto;
    }

    .chatbot_styles .popup .backdrop {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      cursor: pointer;

      background-color: rgba(var(--purple-rgb), 0);
      backdrop-filter: blur(0px);
      transition: background-color var(--timing), backdrop-filter var(--timing);
    }

    .chatbot_styles .popup.open .backdrop {
      background: rgba(var(--purple-rgb), .2);
      backdrop-filter: blur(2px);
      transition: background-color var(--timing), backdrop-filter var(--timing);
    }

    .chatbot_styles .popup .dialog {
      position: relative;
      top: var(--basis_x8);
      left: 50%;
      -webkit-transform: translate3d(-50%, 0, 0);
      transform: translate3d(-50%, 0, 0);
      width: 800px;
      max-width: calc(100% - var(--basis_x8));
      max-height: calc(100% - var(--basis_x16));
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      background: var(--background);
      color: var(--text);
      margin-bottom: var(--basis_x8);
      box-shadow: 0 var(--basis_x16) var(--basis_x32) var(--shadow-color-rgba), 0 var(--basis_x8) var(--basis_x16) var(--shadow-color-rgba), 0 var(--basis_x2) var(--basis_x4) var(--shadow-color-rgba), 0 0 var(--basis_x0_5) var(--shadow-color-rgba);
      border-radius: var(--basis_x2);
      padding: var(--basis_x4) var(--basis_x8);

      transform: translate3d(-50%, 50%, 0);
      opacity: 0;
      transition: transform var(--timing), opacity var(--timing);
    }

    @media (max-height: 700px) {
      .chatbot_styles .popup .dialog {
        top: var(--basis_x4);
        max-height: calc(100% - var(--basis_x8));
      }
    }

    @media (max-height: 600px),
    (max-width: 600px) {
      .chatbot_styles .popup .dialog {
        top: 0;
        height: 100%;
        max-height: 100%;
        max-width: 100%;
        border-radius: 0;
      }
    }

    .chatbot_styles .popup.open .dialog {
      transform: translate3d(-50%, 0, 0);
      opacity: 1;
      transition: transform var(--timing), opacity var(--timing);
    }

    body .slow_connection_info {
      display: none;
    }
    body.slow_connection .slow_connection_info {
      display: block;
      padding: 15px;
      background: var(--yellow);
      color: var(--on-yellow);
      font-weight: bold;
    }

    body .offline_info {
      display: none;
    }
    body.offline .offline_info {
      display: block;
      padding: 15px;
      background: var(--red);
      color: var(--on-red);
      font-weight: bold;
    }
    /*
    body.offline .input_box {
      opacity: 0.5;
      pointer-events: none;
      cursor: not-allowed !important;
      transition: opacity var(--timing);
    }
    */
    body.offline .slow_connection_info {
      display: none;
    }



    .chatbot_styles .chatbot_corner {
      z-index: 1000;
      position: fixed;
      bottom: 20px;
      max-width: 400px;

      /* right: 20px; */
      left: 50%;
      transform: translateX(-50%);

      pointer-events: none;
    }
    .chatbot_styles .chatbot_corner .messages {
      pointer-events: all;
      margin-block-end: 15px;
    }
    .chatbot_styles .chatbot_corner .messages .chatbubble.user .content {
      --shadow-color-intense-rgba: rgba(var(--purple-rgb), .6);
      box-shadow: 0 var(--basis_x16) var(--basis_x32) var(--shadow-color-intense-rgba), 0 var(--basis_x8) var(--basis_x16) var(--shadow-color-intense-rgba), 0 var(--basis_x2) var(--basis_x4) var(--shadow-color-intense-rgba), 0 0 var(--basis_x0_5) var(--shadow-color-intense-rgba) !important;
    }
    .chatbot_styles .chatbot_corner .messages .chatbubble.assistant .content {
      background: var(--gray-lighter);
      --shadow-color-intense-rgba: rgba(var(--purple-light-rgb), .6);
      box-shadow: 0 var(--basis_x16) var(--basis_x32) var(--shadow-color-intense-rgba), 0 var(--basis_x8) var(--basis_x16) var(--shadow-color-intense-rgba), 0 var(--basis_x2) var(--basis_x4) var(--shadow-color-intense-rgba), 0 0 var(--basis_x0_5) var(--shadow-color-intense-rgba) !important;
    }
    .chatbot_styles .chatbot_corner .chatbot_button_triggers {
      display: flex;
      justify-content: flex-end;
      gap: 20px;

      pointer-events: none;
    }
    .chatbot_styles .chatbot_button_triggers button {
      position: relative;
      border-radius: 100px;
      --shadow-color-intense-rgba: rgba(var(--purple-rgb), .6);
      box-shadow: 0 var(--basis_x16) var(--basis_x32) var(--shadow-color-intense-rgba), 0 var(--basis_x8) var(--basis_x16) var(--shadow-color-intense-rgba), 0 var(--basis_x2) var(--basis_x4) var(--shadow-color-intense-rgba), 0 0 var(--basis_x0_5) var(--shadow-color-intense-rgba) !important;

      -khtml-user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;

      pointer-events: all;

      opacity: 0;
      transform: translate3d(0%, 100%, 0);
      transition: opacity var(--timing), transform var(--timing);
    }
    .chatbot_styles .chatbot_button_triggers button.active {
      opacity: 1;
      transform: translate3d(0%, 0%, 0);
    }
    .chatbot_styles .chatbot_button_triggers button.active:hover {
      transform: translate3d(0%, 0%, 0) scale(1.1);
    }
  </style>
</head>

<body class="chatbot_styles">
  <h1>Volt Chat Bot</h1>

  <div style="display: flex; gap: 10px;">
    <button id="default_backend">
      Default Backend
    </button>
    <button id="michaels_backend" class="text">
      Micheals Backend
    </button>
  </div>

  <div class="chatbot_styles">
    <div class="chatbot"></div>
  </div>

  <script>
    function is_dev() {
      return window.location.hostname === 'localhost' || window.location.hostname === '0.0.0.0'
    }
    window.is_dev = is_dev

    async function chatbot_imports () {

      //import {io} from 'https://chat.volt.link/socket.io.esm.min.js'
      //import 'https://chat.volt.link/remarkable.min.js';

      let socket_io_import_url = (
        window.is_dev()
          ? 'http://localhost:4009/socket.io.esm.min.js'
          : 'https://chat.volt.link/socket.io.esm.min.js'
      )

      const { io } = await import(socket_io_import_url)
      window.io = io

      const url = (
        window.is_dev()
          ? 'http://localhost:4009/'
          : 'https://chat.volt.link/'
      )
      window.socket = io(url)

      setInterval(() => {
        const start = Date.now()

        window.socket.emit('ping', () => {
          const duration = Date.now() - start;
          set_slow_status(duration)
        })
      }, 1000)

      /*
      const remarkable_module = await import('https://chat.volt.link/remarkable.min.js')
      window.remarkable = remarkable_module
      */
      return true
    }

    // throw new Error('This is a demo chat-bot for Volt. It can answer some basic questions about Volts policies. Please know that it may halucinate wrong information. If you\'re unsure, check the data it used to generate the answer (i) or ask a human for clarification. You can ask questions in any language. The entered data is sent to servers of the company OpenAI in America. No metadata about you is sent along. or use the Enter-Key.');

    const info_svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 96 960 960"><path d="M442 787h82V536h-82v251Zm38.07-310q20.43 0 34.18-13.513Q528 449.975 528 430q0-21.95-13.795-35.475Q500.41 381 480.018 381q-21.518 0-34.768 13.525T432 429.5q0 20.6 13.82 34.05Q459.64 477 480.07 477Zm.334 524q-88.872 0-166.125-33.084-77.254-33.083-135.183-91.012-57.929-57.929-91.012-135.119Q55 664.594 55 575.638q0-88.957 33.084-166.285 33.083-77.328 90.855-134.809 57.772-57.482 135.036-91.013Q391.238 150 480.279 150q89.04 0 166.486 33.454 77.446 33.453 134.853 90.802 57.407 57.349 90.895 134.877Q906 486.66 906 575.734q0 89.01-33.531 166.247-33.531 77.237-91.013 134.86-57.481 57.623-134.831 90.891Q569.276 1001 480.404 1001Z"/></svg>`
    const feedback_svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 96 960 960"><path d="M83 680q-34 0-58.5-23.944T0 597V351q0-15.529 6-30.265Q12 306 25 292L220 96l34 35.5q6 8.5 10 14.821 4 6.322 4 16.679v9l-28 128h186q26.25 0 44.125 17.981Q488 335.961 488 361.889V413q0 9-1.5 18t-3.5 14l-80 184q-13.079 29.639-34.039 40.319Q348 680 311 680H83Zm241-83 83-186v-27H154l26-129-97 99v243h241Zm416 459-33-35.5q-7-8.5-11-14.82-4-6.323-4-16.68v-9l29-129H534q-26.25 0-44.125-17.375T472 790.269V739q0-9 1.5-18t3.5-14l80-185q13-29 34-39.5t58-10.5h228q34 0 58.5 24t24.5 58v246q0 17-6 31.5T936 859l-196 197ZM636 554l-83 187v27h253l-26 129 97-98.714V554H636ZM83 597V354l97-99-26 129h253v27l-83 186H83Zm794-43v244l-97 99 26-129H553v-27l83-187h241Z"/></svg>`

    // import {io} from '/socket.io.esm.min.js'

    // import '/remarkable.min.js';

    // const markdown = new window.remarkable.Remarkable('full', {
    //   html: true,
    //   typographer: true
    // });

    async function postData(url = '', data = {}) {
      // Default options are marked with *
      try {
        const response = await fetch(url, {
          method: 'POST',
          mode: 'cors',
          cache: 'no-cache',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json',
          },
          referrerPolicy: 'no-referrer',
          body: JSON.stringify(data),
        })
        if (!response.ok) {
          return { response: '', error: response.statusText }
        } else {
          return response.json() // parses JSON response into native JavaScript objects
        }
      } catch (error) {
        console.error('Error:', error);
        return String(error)
      }
    }
    window.postData = postData

    function init_element_nodes () {
      window.messages_node = document.getElementById('messages')
      window.new_message_node = document.getElementById('new_message')
      window.send_message_node = document.getElementById('send_message')
      window.input_box_node = document.getElementById('input_box')
      window.loading_node = document.getElementById('bot_loading')
      window.ping_nodes = document.querySelectorAll('.ping')
    }



    // START events
    window.event_listeners = [] // ['click', '...']
    window.event_callbacks = [
      // {
      //   event_name: 'click',
      //   selector: 'kajshfg',
      //   callback: () => {
      //     console.debug('clicked')
      //   }
      // }
    ]
    function get_node_parents (node, parents = []) {
      if (!Array.isArray(parents)) {
        parents = []
      }
      if (parents.length === 0) {
        parents.push(node)
      }

      const parentNode = node.parentNode

      if (
        parentNode.nodeName !== null
        && parentNode.nodeName !== 'BODY'
        && parentNode.nodeName !== 'HTML'
        && parentNode.nodeName !== '#document'
      ) {
        parents.push(parentNode)
        parents = get_node_parents(parentNode, parents)
      }

      return parents
    }
    function on_any_event (event) {
      const parentNodes = get_node_parents(event.target)
      for (const parentNode of parentNodes) {
        for (const event_callback_info of window.event_callbacks) {
          if (
            parentNode.matches(event_callback_info.selector)
            && event.type === event_callback_info.event_name
          ) {
            event_callback_info.callback(event)
          }
        }
      }
    }
    function re_add_event_listeners() {
      const current_event_listeners = window.event_listeners
      const wished_event_listeners = window.event_callbacks.map(ec => ec.event_name)

      const new_event_listeners = wished_event_listeners.filter(wel => !current_event_listeners.includes(wel))
      const removed_event_listeners = current_event_listeners.filter(cel => !wished_event_listeners.includes(cel))

      for (const event_listener_name of new_event_listeners) {
        window.event_listeners.push(event_listener_name)
        document.addEventListener(event_listener_name, on_any_event)
      }
      for (const event_listener_name of removed_event_listeners) {
        window.event_listeners = window.event_listeners.filter(item => item !== event_listener_name)
        document.removeEventListener(event_listener_name, on_any_event)
      }
    }
    function waitForElm(selector) {
      // source: https://stackoverflow.com/questions/5525071/how-to-wait-until-an-element-exists
      // Wait till the selector is found in the dom and then resolve the promise.
      // I think this does only work in modern browsers.
      return new Promise(resolve => {
        if (document.querySelector(selector)) {
          return resolve(document.querySelector(selector));
        }

        const observer = new MutationObserver(mutations => {
          // for (const mutation of mutations) {
            // if ([...mutation.addedNodes].find(node => node.matches(selector))) { // this only checks the added nodes. not the whole dom like with document.querySelector(selector)
              const node = document.querySelector(selector)
            if (node) { // alternative to the if above
              resolve(node);
              observer.disconnect();
            }
          // }
        });

        observer.observe(document.body, {
          childList: true,
          subtree: true
        });
      });
    }
    function onEvent(event_name, selector, callback) {
      waitForElm(selector)
        .then(() => {
          window.event_callbacks.push({
            event_name,
            selector,
            callback,
          })
          re_add_event_listeners()
        })
    }
    function notOnEvent(event_name, selector) {
      // remove event listerner
      window.event_callbacks = window.event_callbacks.filter(ec => {
        return !(ec.event_name === event_name && ec.selector === selector)
      })
      re_add_event_listeners()
    }
    function new_node_id () {
      return `_${Math.random().toString(36).substring(2, 15)}` // an id should not start with a number. that the reason for the underscore

      // todo: maybe use nanoid
      // export let nanoid=(t=21)=>crypto.getRandomValues(new Uint8Array(t)).reduce(((t,e)=>t+=(e&=63)<36?e.toString(36):e<62?(e-26).toString(36).toUpperCase():e>62?"-":"_"),"");
    }
    // END events



    function trackEvent(...attributes) {
      if (window.hasOwnProperty('umami')) {
        window.umami.trackEvent(...attributes)
      }
    }





    window.backend_version = 'michael' // default / michael

    function init_backend_switcher () {
      const button_default_backend = document.querySelector('#default_backend')
      if (!!button_default_backend) {
        const button_michaels_backend = document.querySelector('#michaels_backend')

        function set_backend_version(new_backend_version) {
          window.backend_version = new_backend_version
          if (new_backend_version === 'default') {
            button_default_backend.classList.remove('text')
            button_michaels_backend.classList.add('text')
          } else {
            button_default_backend.classList.add('text')
            button_michaels_backend.classList.remove('text')
          }
        }

        button_default_backend.addEventListener('click', () => set_backend_version('default'))
        button_michaels_backend.addEventListener('click', () => set_backend_version('michael'))
      }
    }





    window.messages = [
      // {
      //   role: 'user',
      //   content: `Was ist Volt?`,
      //   information: '',
      // },
      // {
      //   role: 'assistant',
      //   content: `You can contact Volt Potsdam via email at potsdam@voltdeutschland.org. Information about Volt Potsdam events can be found on their Instagram page (@voltpotsdam) and their website (www.voltbrandenburg.org/potsdam).`,
      //   information: `- abc\n- 123`,
      // },
    ]
    function get_previous_messages(last_message_content) {
      const previous_messages = []
      for (const message of window.messages) {
        previous_messages.push(message)
        if (message.content === last_message_content) {
          break
        }
      }
      return previous_messages
    }

    function markdown_to_html(text) {
      const url_regexp = /(?<!@)\b((?:(?:https?|ftp):\/\/)?([\w-]+(?:\.[\w-]+)+(?:[\w.,@?^=%&:/~+#-]*[\w@?^=%&/~+#-])?(?<!\.)))/gim;
      const email_regexp = /([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/gim;

      // make all URLs have a protocol
      const url_matches = text.matchAll(url_regexp)
      if (url_matches) {
        for (const url_match of url_matches) {
          const url = url_match[0]
          if (
            !url.startsWith('https://')
            && !url.startsWith('http://')
            && !url.startsWith('ftp://')
          ) {
            text = text.replaceAll(url, 'https://' + url)
          }
        }
      }

      // text = markdown.render(text)

      text = text
        .replace(url_regexp, '<a href="$1" target="_blank">$2</a>') // Make URLs clickable
        .replace(email_regexp, '<a href="mailto:$1">$1</a>') // Make emails clickable
        .replace(/^- (.+)$/gm, `<li>$1</li>`) // replace - with <li>
        .replace(/\n/g, '<br />') // replace \n with <br />
        .replace(/<\/li><br \/>/g, '</li>') // remove accidental <br /> after </li>
        .replace(/(<br \/>)+$/, '') // remove linebreaks at the end

      return text
    }
    function display_messages() {
      const new_messages_node = document.createElement('div')

      for (const message of window.messages) {
        const this_message_content = message.content

        const new_chatbubble = document.createElement('div')
        new_chatbubble.classList.add('chatbubble')
        new_chatbubble.classList.add(message.role)

        let text = ''
        if (typeof message.content === 'string' && message.content.length > 0) {
          text = message.content
        }
        if (typeof message.error === 'string' && message.error.length > 0) {
          new_chatbubble.classList.add('error')
          text = message.error
        }

        text = markdown_to_html(text)

        const new_content = document.createElement('div')
        new_content.classList.add('content')
        new_content.innerHTML = text
        new_chatbubble.appendChild(new_content)

        const chat_history = get_previous_messages(this_message_content)
          .map(message => `${message.role}: ${message.content}`)
          .join('\n\n')

        if (message.role === 'assistant') {
          // const new_facts = document.createElement('div')
          // new_facts.classList.add('facts')
          // for (const fact of message.facts) {
          //   const new_fact = document.createElement('div')
          //   new_fact.classList.add('fact')
          //   new_fact.innerHTML = fact
          //   new_facts.appendChild(new_fact)
          // }
          // new_chatbubble.appendChild(new_facts)

          const new_actions = document.createElement('div')
          new_actions.classList.add('actions')

          if (message.information) {
            // <button class="text" id="info_toggle_button">${info_svg}</button>
            const new_info_button = document.createElement('button')
            new_info_button.classList.add('text')
            new_info_button.innerHTML = info_svg

            const new_info_button_id = new_node_id()
            new_info_button.setAttribute('id', new_info_button_id)
            onEvent('click', `#${new_info_button_id}`, () => {
              trackEvent('clicked_show_answer_info', 'clicked_show_answer_info')
              open_popup(`
                <h2>The answer</h2>
                <br />
                ${markdown_to_html(message.content)}
                <hr />
                <h2>Data used to generate the answer</h2>
                <br />
                <p>The data changes based on the asked question and the previous context.</p>
                ${markdown_to_html(message.information)}
              `)
            })

            new_actions.append(new_info_button)
          }

          const new_feedback_button = document.createElement('a')
          new_feedback_button.setAttribute('target', '_blank')
          new_feedback_button.setAttribute('href', `https://docs.google.com/forms/d/e/1FAIpQLSebrPY7u6YWMGzj3rMRnDjhBvmCPwXLFyS1D7S1fBdpi2IwmQ/viewform?usp=pp_url&entry.190795242=${encodeURIComponent(chat_history)}`)
          new_feedback_button.innerHTML = `<button class="text">${feedback_svg}</button>`
          const new_feedback_button_id = new_node_id()
          new_feedback_button.setAttribute('id', new_feedback_button_id)
          onEvent('click', `#${new_feedback_button_id}`, () => {
            trackEvent('clicked_answer_feedback', 'clicked_answer_feedback')
          })
          new_actions.append(new_feedback_button)

          new_chatbubble.appendChild(new_actions)
        }

        new_messages_node.appendChild(new_chatbubble)
      }

      window.messages_node.innerHTML = new_messages_node.innerHTML
    }

    function send_messages() {
      window.loading_node.classList.add('active')

      trackEvent('send_messages', 'send_messages')

      window.socket.emit('query', {
        messages: window.messages,
        backend_version: window.backend_version,
      })

      /*
      const url = (
        is_dev()
          ? 'http://localhost:4009/api/chat'
          : 'https://chat.volt.link/api/chat'
      )
      postData(url, { messages })
        .then(new_response => {
          window.loading_node.classList.remove('active')

          window.messages.push({
            role: 'assistant',
            content: new_response.response || null,
            error: new_response.error || null,
          })
          display_messages()

          // scroll to the new_message_node
          window.input_box_node.scrollIntoView({ behavior: 'smooth', block: 'end', inline: 'nearest' })
          // focus new_message_node
          window.new_message_node.focus()
        })
        .catch(new_response => {
          window.loading_node.classList.remove('active')

          window.messages.push({
            role: 'assistant',
            content: new_response.response || null,
            error: new_response.error || null,
          })
          display_messages()
        })
        */
    }
    function use_text_input() {

      const new_message = window.new_message_node.value
        .replace(/^[\s\n\r]+/gm, '') // remove lines and whitespace at the beginning
        .replace(/[\s\n\r]+$/gm, '') // remove lines and whitespace at the end

      if (new_message.length === 0) {
        return
      }

      window.messages.push({ role: 'user', content: new_message })
      display_messages()
      window.new_message_node.value = ''
      send_messages()
    }

    function open_popup(dialog_html) {
      const random_ele_id = new_node_id()

      const new_popup = document.createElement('div')
      new_popup.classList.add('popup')
      new_popup.setAttribute('id', random_ele_id)
      new_popup.innerHTML = `
        <div class="backdrop close_target"></div>
        <div class="dialog">
          <button class="close_target">Close</button>
          <br />
          <br />
          ${dialog_html}
        </div>
      `
      onEvent('click', `#${random_ele_id} .close_target`, () => {
        new_popup.classList.remove('open')
        setTimeout(() => {
          new_popup.remove()
          notOnEvent('click', `#${random_ele_id} .close_target`)
        }, 200)
      })

      document.querySelector('#overlays').appendChild(new_popup)

      waitForElm(`#${random_ele_id}`)
        .then(() => {
          setTimeout(() => {
            new_popup.classList.add('open')
          }, 100)
        })
    }

    function check_url_for_message() {
      const url = new URL(window.location.href)
      const message = url.searchParams.get('msg')
      if (message) {
        window.messages.push({ role: 'user', content: message })
        display_messages()
        send_messages()
      }
    }

    function set_ping(ping) {
      window.ping_nodes.forEach(ping_node => {
        ping_node.innerHTML = ping
      })
    }
    function set_slow_status(ping) {
      if (ping >= 300) { // if ping is longer than 300ms
        set_ping(ping)
        document.querySelector('body').classList.add('slow_connection')
      } else {
        document.querySelector('body').classList.remove('slow_connection')
      }
    }
    function set_online_status(online) {
      if (online) {
        document.querySelector('body').classList.remove('offline')
      } else {
        document.querySelector('body').classList.add('offline')
      }
    }
    function init_online_check() {
      set_online_status(navigator.onLine)

      window.addEventListener('online', () => {
        // Set set_online_status to online when they change to online.
        set_online_status(true)
      })

      window.addEventListener('offline', () => {
        // Set set_online_status to offline when they change to offline.
        set_online_status(false)
      })
    }







    function push_or_replace_msg (new_message, options = {}) {
      const id = new_message.id
      const content = new_message.content

      const message_index = window.messages.findIndex(message => message.id === id)
      if (message_index === -1) {
        // create new message
        window.messages.push(new_message)
      } else {
        if (options.replace === true) {
          // append to existing message by id
          window.messages[message_index] = new_message
        } else {
          // append to existing message by id
          window.messages[message_index].content += content
        }
      }
    }

    function init_socket() {
      window.socket.on('connect', () => set_online_status(window.socket.connected))
      window.socket.on('reconnect', () => set_online_status(window.socket.connected))
      window.socket.on('disconnect', () => set_online_status(window.socket.connected))
      window.socket.on('error', console.error.bind(console));
      window.socket.on('response', data => {
      const { id, information, content, error } = data

      window.loading_node.classList.remove('active')

      push_or_replace_msg({
        id,
        role: 'assistant',
        information: information || null,
        content: content || null,
        error: error || null,
      }, { replace: true })
      display_messages()
    })
    window.socket.on('partial_response', data => {
      const { id, information, content, error } = data

      window.loading_node.classList.remove('active')

      push_or_replace_msg({
        id,
        role: 'assistant',
        information: information || null,
        content: content || null,
        error: error || null,
      }, { replace: false })
      display_messages()
    })
    }

    function init_addEventListeners() {
      window.send_message_node.addEventListener('click', use_text_input)

      // fire use_text_input when pressing the shift and enter key together
      window.new_message_node.addEventListener('keyup', function (event) {
        if (event.key === 'Enter') { // event.shiftKey === true
          event.preventDefault()
          use_text_input()
        }
      })

      window.addEventListener('load', check_url_for_message)
      window.addEventListener('popstate', check_url_for_message) // on url change
    }

    function show_inline_chat_bot_frame() {
        const show_chat_bot_nodes = document.querySelectorAll('.chatbot')
        for (let node of show_chat_bot_nodes) {
             node.innerHTML = `
<div class="chatbot_center">
<!--
  <p><strong>
    This is a chat-bot demo for Volt. It can answer some basic questions about Volt and its policies.
  </strong></p>
  <p>You can ask questions in any language.</p>
-->

  <div class="messages" id="messages">
      <div class="chatbubble assistant"><div class="content"><p>Please read the following disclaimer before using the chatbot: <a target="_blank" href="https://chat.volt.link/VOLT%20EUROPA%20Chatbot%20Disclaimer.pdf">Terms of Use of the Chatbot</a>.</p></div></div>
      <div class="chatbubble assistant"><div class="content"><p><strong>
        What do you want to know?
      </strong></p></div></div>
      <div class="chatbubble assistant"><div class="content"><p>You can ask questions in any language.</p></div></div>
  </div>
  <p class="offline_info caption">
    You are offline or we could not connect to our server.<br />
    Please check your internet connection.
  </p>
  <p class="slow_connection_info caption">
    Your connection seams slow.<br />
    <br />
    The website should work fine, but you may need to wait longer for an answer (at least <span class="ping"></span>ms). Please check your internet connection to fix this.
  </p>
  <div class="bot_loading" id="bot_loading">
    <p class="caption">
      Thinking…
    </p>
  </div>
  <div class="input_box" id="input_box">
    <textarea id="new_message" rows="1" cols="50" placeholder="Ask away…"></textarea>
    <br />
    <div style="display: flex; gap: 20px; margin-block-start: 5px;">
      <p class="caption"><a target="_blank" href="https://drive.google.com/file/d/1UOdlEjoF9LFwBbZOXPDfsnuvv13tqmlk/view">Terms of Use of the Chatbot</a> • The entered data is sent to servers of the company <a href="https://platform.openai.com/docs/data-usage-policies" target="_blank">OpenAI</a> in America. It is not permanently stored there. No metadata about you is sent along.</p>

      <div>
        <button class="green" id="send_message">
          <!-- Senden -->
          Send
        </button>
        <p class="caption">
          <!-- oder verwende die Enter-Taste -->
          or use the Enter-Key.
        </p>
      </div>
    </div>
    <br />
    <br />
  </div>
</div>

<div id="overlays"></div>
  `
        }
      }


































  function deselect_all_text () {
    document.getSelection().removeAllRanges();
  }
  function get_current_text_selection () {
    return document.getSelection().toString()
  }
  function show_translate_button () {
    document.querySelector('#translate_button').classList.add('active')
  }
  function hide_translate_button() {
    document.querySelector('#translate_button').classList.remove('active')
  }

  async function load_translation (text, language) {
    const url = (
      window.is_dev()
        ? 'http://localhost:4009/api/chat'
        : 'https://chat.volt.link/api/chat'
    )

    const t_messages = [
      { role: 'user', content: `Translate the following text into ${language}:` },
      { role: 'user', content: text }
    ]
    return postData(url, {
      messages: t_messages,
      backend_version: window.backend_version,
    })
  }

  function init_translate_on_text_selection() {

    const chatbot_corner_html = `
      <div class="chatbot_corner">
      <!-- <div class="messages">
        <div class="chatbubble user">
          <div class="content">Hello World Hello World Hello World Hello WorldHello World Hello WorldHello World Hello WorldHello WorldHello World Hello World Hello WorldHello World Hello World Hello World  Hello World  Hello World Hello World</div>
        </div>
        <div class="chatbubble assistant">
          <div class="content">Hello World Hello World Hello World Hello WorldHello World Hello WorldHello World Hello WorldHello WorldHello World Hello World Hello WorldHello World Hello World Hello World  Hello World  Hello World Hello World</div>
        </div>
      </div> -->
      <div class="chatbot_button_triggers">
          <button id="translate_button" class="purple">Translate</button>
          <!-- <button id="chat_button" class="purple active">Chat</button> -->
      </div>
    </div>
    `

    const chatbot_corner_node = document.createElement('div')
    chatbot_corner_node.classList.add('chatbot_styles')
    chatbot_corner_node.innerHTML = chatbot_corner_html
    document.body.appendChild(chatbot_corner_node)

    const translate_button = document.querySelector('#translate_button')

    if (!translate_button) {
      return null
    }

    translate_button.addEventListener('click', () => {

        const original_selected_text = get_current_text_selection()
        deselect_all_text()
        hide_translate_button()

        const translate_popup_id = new_node_id()
        const lang_input_id = `lang_input_${translate_popup_id}`
        const start_translation_id = `start_translation_${translate_popup_id}`
        const loading_result_id = `loading_result_${translate_popup_id}`
        const translation_result_id = `translation_result_${translate_popup_id}`

        open_popup(`
          <h2>Translate</h2>
          <br />

          <h4>Original Text:</h4>
          <p>${original_selected_text}</p>

          <h4>Choose a Language:</h4>
          <p>Just type what language you want to translate to.</p>
          <input type="text" value="" placeholder="English / German / French / multiple locales" id="${lang_input_id}"/>
          <br />
          <br />
          <button class="green" id="${start_translation_id}">Translate</button>
          <br />
          <br />
          <div id="${loading_result_id}" style="display:none;">Loading…<br /><br /></div>
          <div id="${translation_result_id}"></div>
        `)
        onEvent('click', `#${start_translation_id}`, () => {

          const lang_input = document.querySelector(`#${lang_input_id}`)
          const loading_result = document.querySelector(`#${loading_result_id}`)
          const translation_result = document.querySelector(`#${translation_result_id}`)

          const language = (lang_input.value).trim()

          if (language === '') {
            alert('Please enter a language.')
            return
          }

          loading_result.style.display = 'block'

          load_translation(original_selected_text, language)
            .then(({
              information,
              content,
              error,
            }) => {
              loading_result.style.display = 'none'

              if (error) {
                console.error('error', error)
                translation_result.innerHTML = markdown_to_html(String(error))
                return
              }

              if (content) {
                translation_result.innerHTML = `
                  <h3>Translation:</h3>
                  ${markdown_to_html(content)}
                `
              }
            })
            .catch(error => {
              loading_result.style.display = 'none'
              console.error('error', error)
            })

        })
      })

    function debounce(func, delay) {
      let timeoutId;
      return function () {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(func, delay);
      };
    }

    const handleSelectionChange = debounce(() => {
      const selected_text = get_current_text_selection()
      if (selected_text === '') {
        hide_translate_button()
      } else {
        show_translate_button()
      }
    }, 300); // Adjust the delay (in milliseconds) according to your needs

    document.addEventListener('selectionchange', handleSelectionChange)
  }


  window.addEventListener('load', () => {
    show_inline_chat_bot_frame()
    init_element_nodes()
    chatbot_imports()
      .then(() => {
        init_online_check()
        init_backend_switcher()
        init_socket()
        // display_messages()
        init_addEventListeners()
        init_translate_on_text_selection();
      })
  })
</script>

</body>

</html>
