<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Volt Chat Bot</title>

  <meta charset="utf-8" />
  <link rel="icon" href="/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="white" media="(prefers-color-scheme: dark)" />
  <meta name="background-color" content="white" media="(prefers-color-scheme: dark)" />

  <link rel="apple-touch-icon" href="/volt-logo-white-192.png" />
  <link rel="manifest" href="/manifest.json" />

  <script async defer data-website-id="81c67243-c55c-476c-ada6-a9d97324d731" src="https://umami.volteuropa.org/umami.js" data-domains="chat.volt.link"></script>

  <style>
    :root {
      --purple-lighter: #e6ccff;
      --purple-light: #b58dd9;
      --purple: #502379;
      --purple-dark: #19022d;
      --purple-darker: #0d0019;

      --green-lighter: #d1ffe9;
      --green-light: #94fcc9;
      --green: #1bbe6f;
      --green-dark: #005029;
      --green-darker: #00190d;

      --red-lighter: #ffd6cc;
      --red-light: #ffad93;
      --red: #e63e12;
      --red-dark: #641400;
      --red-darker: #190500;

      --yellow-lighter: #fff1cc;
      --yellow-light: #ffe787;
      --yellow: #fdc220;
      --yellow-dark: #926f0d;
      --yellow-darker: #191300;

      --blue-lighter: #dff5ff;
      --blue-light: #c3f1ff;
      --blue: #82d0f4;
      --blue-dark: #30708e;
      --blue-darker: #031219;

      --gray-lighter: #ffffff;
      --gray-light: #edecee;
      --gray: #c2bfc4;
      --gray-dark: #726f76;
      --gray-darker: #181719;

      --on-purple-lighter: var(--purple-darker);
      --on-purple-light: var(--purple-darker);
      --on-purple: var(--gray-lighter);
      --on-purple-dark: var(--gray-lighter);
      --on-purple-darker: var(--gray-lighter);

      --on-green-lighter: var(--green-darker);
      --on-green-light: var(--green-darker);
      --on-green: var(--gray-lighter);
      --on-green-dark: var(--gray-lighter);
      --on-green-darker: var(--gray-lighter);

      --on-red-lighter: var(--red-darker);
      --on-red-light: var(--red-darker);
      --on-red: var(--gray-lighter);
      --on-red-dark: var(--gray-lighter);
      --on-red-darker: var(--gray-lighter);

      --on-yellow-lighter: var(--yellow-darker);
      --on-yellow-light: var(--yellow-darker);
      --on-yellow: var(--yellow-darker);
      --on-yellow-dark: var(--gray-lighter);
      --on-yellow-darker: var(--gray-lighter);

      --on-blue-lighter: var(--blue-darker);
      --on-blue-light: var(--blue-darker);
      --on-blue: var(--blue-darker);
      --on-blue-dark: var(--gray-lighter);
      --on-blue-darker: var(--gray-lighter);

      --on-gray-lighter: var(--gray-darker);
      --on-gray-light: var(--gray-darker);
      --on-gray: var(--gray-darker);
      --on-gray-dark: var(--gray-lighter);
      --on-gray-darker: var(--gray-lighter);

      --alpha-more: 0.8;
      --alpha: 0.6;
      --alpha-less: 0.2;

      --blur: 20px;

      --timing: .2s ease-in-out;

      --font-family: 'Ubuntu', 'Noto Kufi Arabic', 'Geeza Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      --font-family-code: 'Ubuntu Mono', 'Noto Kufi Arabic', 'Geeza Pro', 'Courier New', Courier, monospace;

      --basis: 1rem;
      --basis_x0_5: calc(var(--basis) * 0.5);
      --basis_x2: calc(var(--basis) * 2);
      --basis_x4: calc(var(--basis) * 4);
      --basis_x8: calc(var(--basis) * 8);
    }

    :root {
      --font-family-website-title: var(--font-family);
      --font-family-headline: var(--font-family);
      --font-family-text: var(--font-family);
      --font-family-button: var(--font-family);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }


    body {
      width: 600px;
      max-width: 100%;
      padding: 20px;
      margin: 0 auto;
      margin-block-end: 33vh;
    }

    h1 {
      font-family: var(--font-family-website-title);
      font-weight: bold;
      font-size: 60px;
      letter-spacing: -1.5px;
      line-height: 1.1;
      margin-block-end: 2rem;
    }

    @media (max-width: 700px) {
      h1 {
        font-size: 40px;
      }
    }

    p {
      margin-block-end: 1rem;
    }

    body,
    p {
      font-family: var(--font-family-text);
      font-weight: normal;
      font-size: 18px;
      letter-spacing: 0.5px;
      line-height: 1.2;
      color: var(--purple);
    }
    .caption {
      font-size: 14px;
      margin: 0;
      color: var(--gray);
    }

    code {
      font-family: var(--font-family-code);
      font-size: 19px;
      white-space: break-spaces;
    }

    textarea {
      appearance: none;
      width: 100%;
      min-height: 80px;
      padding: 15px;
      resize: vertical;
      font-family: inherit;
      font-size: inherit;
      color: inherit;
      border-radius: 0;
      border: none;
      outline: none;
      box-shadow: inset 0 0 0 1px var(--gray);
      transition: box-shadow 0.2s ease;
    }

    textarea:hover {
      box-shadow: inset 0 0 0 2px var(--purple);
    }

    textarea:focus {
      box-shadow: inset 0 0 0 5px var(--purple);
    }

    button {
      display: inline-flex;

      font-family: var(--font-family-button);
      text-decoration: none;

      font-weight: inherit;
      font-size: inherit;
      letter-spacing: inherit;

      /* text-transform: uppercase; */
      border: 0;
      font-weight: bold;
      cursor: pointer;

      padding: 10px 20px;
      border-radius: 0;
      font-weight: bold;
      box-shadow: 0 0 0 0 var(--purple-dark);
      transition: box-shadow 0.2s ease;
    }

    button {
      color: var(--text-color);
      fill: var(--text-color);
      background: var(--background-color);
    }

    button svg {
      height: 20px;
      width: auto;
    }

    button.text {
      color: var(--background-color);
      fill: var(--background-color);
      /* background: var(--text-color); */
      background: transparent;
    }

    button {
      --background-color: var(--purple);
      --text-color: var(--on-purple);
    }
/* 
    button.gray {
      --background-color: var(--gray);
      --text-color: var(--on-gray);
    } */

    button.red {
      --background-color: var(--red);
      --text-color: var(--on-red);
    }

    button.blue {
      --background-color: var(--blue-dark);
      --text-color: var(--on-blue-dark);
    }

    button.green {
      --background-color: var(--green);
      --text-color: var(--on-green);
    }

    button.yellow {
      --background-color: var(--yellow-dark);
      --text-color: var(--on-yellow-dark);
    }

    button.small {
      padding: 5px 10px;
      font-size: 14px;
    }

    button[data-selected="true"] {
      box-shadow: 0 0 0 2px var(--background-color);
    }

    button:not(:disabled):hover {
      box-shadow: 0 0 0 2px var(--background-color);
      text-decoration: none;
    }

    button.small:not(:disabled):hover {
      box-shadow: 0 0 0 2px var(--background-color);
    }

    button:not(:disabled):active,
    button:not(:disabled):focus,
    button:not(:disabled).active,
    a.active button:not(:disabled) {
      box-shadow: 0 0 0 0 var(--background-color);
      text-decoration: none;
    }

    a {
      text-decoration: underline;
      color: inherit;
    }
    a:hover,
    a:active,
    a:focus,
    a:visited {
      text-decoration: double underline;
      color: inherit;
    }


    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .messages {
      display: flex;
      flex-direction: column;
    }
    .chatbubble {
      position: relative;
      display: inline-flex;
      flex-direction: row;
      gap: 10px;
    }
    .chatbubble.user {
      flex-direction: row-reverse;
    }
    .chatbubble .content {
      padding: 10px;
      margin-block-end: 10px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .chatbubble .actions {
      display: flex;
      align-items: flex-start;
      align-content: flex-start;
      flex-wrap: wrap;
    }
    .chatbubble.assistant .content {
      align-self: flex-start;
      background: var(--gray-light);
      color: var(--purple);
      /* padding: 0; */
      border-radius: 10px 10px 10px 0;
    }
    .chatbubble.assistant.error {
      color: var(--red);
    }
    .chatbubble.user .content {
      align-self: flex-end;
      background: var(--purple);
      color: var(--on-purple);
      border-radius: 10px 10px 0 10px;
    }
    .chatbubble.user.error {
      background: var(--red);
      color: var(--on-red);
    }
    .chatbubble p {
      margin: 0;
      color: inherit;
    }

    .input_box {
      display: flex;
      flex-direction: column;
      align-items: end;
    }

    .loading {
      opacity: 0;
      transition-delay: 0s;
      transition: opacity 0s ease;
    }
    .loading.active {
      opacity: 1;
      transition-delay: 1s;
      transition: opacity 1s ease;
    }
    .loading p.caption {
      color: var(--purple);
    }

    li {
      margin-inline-start: 20px;
    }
  </style>
</head>

<body>
  <h1>Volt Chat Bot</h1>
  <!-- <p><strong>Der Chat-Bot kann dir einige Fragen zu Volt Potsdam, und technischen Fragen zu Volt beantworten. Es stehen aber auch ein paar generelle Information zu gesamt Volt zur Verfügung.</strong><br />You should be able to ask questions in any language.</p> -->
  <!-- <p><strong>Der Chat-Bot kann dir technischen Fragen zu Volt beantworten. Es stehen aber auch ein paar generelle Information zu gesamt Volt zur Verfügung.</strong><br />You should be able to ask questions in any language.</p> -->
  <!-- <p><strong>The chatbot can answer technical questions about Volt. However, there are also some general information available about Volt as a whole.</strong><br /><br />You can ask questions in any language.</p> -->
  <p><strong>
    This is a demo chat-bot for Volt. It can answer some basic questions about Volts policies.
  </strong></p>
  <p><strong>
    Please know that the bot may sometimes halucinate wrong information. If you're unsure, ask a human for clarification.
  </strong></p>
  <p>You can ask questions in any language.</p>

  <div class="messages" id="messages"></div>
  <div class="loading" id="loading">
    <p class="caption">
      <!-- Am denken… -->
      Thinking…
    </p>
  </div>
  <div class="input_box" id="input_box">
    <textarea id="new_message" rows="1" cols="50" placeholder="What do you want to know or need help with?"></textarea>
    <!-- Was möchtest du über Volt wissen oder brauchst Hilfe bei? -->
    <br />
    <div style="display: flex; gap: 20px; margin-block-start: 5px;">
      <!-- <p class="caption">Die eingegebenen Daten werden an Server der Firma <a href="https://platform.openai.com/docs/data-usage-policies" target="_blank">OpenAI</a> in Amerika gesendet. Es werden keine Metadaten über dich mitgeschickt.</p> -->

      <p class="caption">The entered data is sent to servers of the company <a href="https://platform.openai.com/docs/data-usage-policies" target="_blank">OpenAI</a> in America. No metadata about you is sent along.</p>

      <button class="green" id="send_message">
        <!-- Senden -->
        Send
      </button>
    </div>
    <p class="caption">
      <!-- oder verwende die Enter-Taste -->
      or use the Enter-Key.
    </p>
    <br />
    <br />
  </div>

  <script type="module">

    const info_svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 96 960 960"><path d="M442 787h82V536h-82v251Zm38.07-310q20.43 0 34.18-13.513Q528 449.975 528 430q0-21.95-13.795-35.475Q500.41 381 480.018 381q-21.518 0-34.768 13.525T432 429.5q0 20.6 13.82 34.05Q459.64 477 480.07 477Zm.334 524q-88.872 0-166.125-33.084-77.254-33.083-135.183-91.012-57.929-57.929-91.012-135.119Q55 664.594 55 575.638q0-88.957 33.084-166.285 33.083-77.328 90.855-134.809 57.772-57.482 135.036-91.013Q391.238 150 480.279 150q89.04 0 166.486 33.454 77.446 33.453 134.853 90.802 57.407 57.349 90.895 134.877Q906 486.66 906 575.734q0 89.01-33.531 166.247-33.531 77.237-91.013 134.86-57.481 57.623-134.831 90.891Q569.276 1001 480.404 1001Z"/></svg>`
    const feedback_svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 96 960 960"><path d="M83 680q-34 0-58.5-23.944T0 597V351q0-15.529 6-30.265Q12 306 25 292L220 96l34 35.5q6 8.5 10 14.821 4 6.322 4 16.679v9l-28 128h186q26.25 0 44.125 17.981Q488 335.961 488 361.889V413q0 9-1.5 18t-3.5 14l-80 184q-13.079 29.639-34.039 40.319Q348 680 311 680H83Zm241-83 83-186v-27H154l26-129-97 99v243h241Zm416 459-33-35.5q-7-8.5-11-14.82-4-6.323-4-16.68v-9l29-129H534q-26.25 0-44.125-17.375T472 790.269V739q0-9 1.5-18t3.5-14l80-185q13-29 34-39.5t58-10.5h228q34 0 58.5 24t24.5 58v246q0 17-6 31.5T936 859l-196 197ZM636 554l-83 187v27h253l-26 129 97-98.714V554H636ZM83 597V354l97-99-26 129h253v27l-83 186H83Zm794-43v244l-97 99 26-129H553v-27l83-187h241Z"/></svg>`

    import {io} from '/socket.io.esm.min.js'

    import '/remarkable.min.js';

    const markdown = new window.remarkable.Remarkable('full', {
      html: true,
      typographer: true
    });

    async function postData(url = '', data = {}) {
      // Default options are marked with *
      try {
        const response = await fetch(url, {
          method: 'POST',
          mode: 'cors',
          cache: 'no-cache',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json',
          },
          referrerPolicy: 'no-referrer',
          body: JSON.stringify(data),
        })
        if (!response.ok) {
          return { response: '', error: response.statusText }
        } else {
          console.log('response', response)
          return response.json() // parses JSON response into native JavaScript objects
        }
      } catch (error) {
        console.error('Error:', error);
        return String(error)
      }
    }


    const messages_node = document.getElementById('messages')
    const new_message_node = document.getElementById('new_message')
    const send_message_node = document.getElementById('send_message')
    const input_box_node = document.getElementById('input_box')
    const loading_node = document.getElementById('loading')

    let messages = [
      // {
      //   role: 'assistant',
      //   content: ``,
      // },
      // {
      //   role: 'user',
      //   content: `Was ist Volt?`,
      // },
    ]
    function get_previous_messages(last_message_content) {
      const previous_messages = []
      for (const message of messages) {
        previous_messages.push(message)
        if (message.content === last_message_content) {
          break
        }
      }
      return previous_messages
    }

    function display_messages() {
      const new_messages_node = document.createElement('div')


      for (const message of messages) {
        const this_message_content = message.content

        const new_chatbubble = document.createElement('div')
        new_chatbubble.classList.add('chatbubble')
        new_chatbubble.classList.add(message.role)

        let text = ''
        if (typeof message.content === 'string' && message.content.length > 0) {
          text = message.content
        }
        if (typeof message.error === 'string' && message.error.length > 0) {
          new_chatbubble.classList.add('error')
          text = message.error
        }


        const url_regexp = /(?<!@)\b((?:(?:https?|ftp):\/\/)?([\w-]+(?:\.[\w-]+)+(?:[\w.,@?^=%&:/~+#-]*[\w@?^=%&/~+#-])?(?<!\.)))/gim;
        const email_regexp = /([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/gim;

        // make all URLs have a protocol
        const url_matches = text.matchAll(url_regexp)
        if (url_matches) {
          for (const url_match of url_matches) {
            const url = url_match[0]
            if (
              !url.startsWith('https://')
              && !url.startsWith('http://')
              && !url.startsWith('ftp://')
            ) {
              text = text.replaceAll(url, 'https://' + url)
            }
          }
        }

        text = markdown.render(text)

        text = text
          .replace(url_regexp, '<a href="$1" target="_blank">$2</a>') // Make URLs clickable
          .replace(email_regexp, '<a href="mailto:$1">$1</a>') // Make emails clickable
          .replace(/^- (.+)$/gm, `<li>$1</li>`) // replace - with <li>
          .replace(/\n/g, '<br />') // replace \n with <br />
          .replace(/<\/li><br \/>/g, '</li>') // remove accidental <br /> after </li>
          .replace(/(<br \/>)+$/, '') // remove linebreaks at the end

        const new_content = document.createElement('div')
        new_content.classList.add('content')
        new_content.innerHTML = text
        new_chatbubble.appendChild(new_content)

        const chat_history = get_previous_messages(this_message_content)
          .map(message => `${message.role}: ${message.content}`)
          .join('\n\n')

        if (message.role === 'assistant') {
          // const new_facts = document.createElement('div')
          // new_facts.classList.add('facts')
          // for (const fact of message.facts) {
          //   const new_fact = document.createElement('div')
          //   new_fact.classList.add('fact')
          //   new_fact.innerHTML = fact
          //   new_facts.appendChild(new_fact)
          // }
          // new_chatbubble.appendChild(new_facts)

          const new_actions = document.createElement('div')
          new_actions.classList.add('actions')
          new_actions.innerHTML = `
            <a target="_blank" href="https://docs.google.com/forms/d/e/1FAIpQLSebrPY7u6YWMGzj3rMRnDjhBvmCPwXLFyS1D7S1fBdpi2IwmQ/viewform?usp=pp_url&entry.190795242=${encodeURIComponent(chat_history)}">
              <button class="text">${feedback_svg}</button>
            </a>
          `
          new_chatbubble.appendChild(new_actions)

        }

        new_messages_node.appendChild(new_chatbubble)
      }

      messages_node.innerHTML = new_messages_node.innerHTML
    }

    function is_dev() {
      return window.location.hostname === 'localhost' || window.location.hostname === '0.0.0.0'
    }

    function send_messages() {
      loading_node.classList.add('active')

      if (window.hasOwnProperty('umami')) {
        window.umami.trackEvent('send_messages', 'send_messages')
      }

      socket.emit('query', { messages });

      /*
      const url = (
        is_dev()
          ? 'http://0.0.0.0:4009/api/chat'
          : 'https://chat.volt.link/api/chat'
      )
      postData(url, { messages })
        .then(new_response => {
          loading_node.classList.remove('active')

          messages.push({
            role: 'assistant',
            content: new_response.response || null,
            error: new_response.error || null,
          })
          display_messages()

          // scroll to the new_message_node
          input_box_node.scrollIntoView({ behavior: 'smooth', block: 'end', inline: 'nearest' })
          // focus new_message_node
          new_message_node.focus()
        })
        .catch(new_response => {
          loading_node.classList.remove('active')

          messages.push({
            role: 'assistant',
            content: new_response.response || null,
            error: new_response.error || null,
          })
          display_messages()
        })
        */
    }
    function use_text_input() {

      const new_message = new_message_node.value
        .replace(/^[\s\n\r]+/gm, '') // remove lines and whitespace at the beginning
        .replace(/[\s\n\r]+$/gm, '') // remove lines and whitespace at the end

      if (new_message.length === 0) {
        return
      }

      messages.push({ role: 'user', content: new_message })
      display_messages()
      new_message_node.value = ''
      send_messages()
    }

    send_message_node.addEventListener('click', use_text_input)

    // fire use_text_input when pressing the shift and enter key together
    new_message_node.addEventListener('keyup', function(event) {
      if (event.key === 'Enter') { // event.shiftKey === true
        event.preventDefault()
        use_text_input()
      }
    })

    display_messages()



















    const url = (
      is_dev()
        ? 'http://0.0.0.0:4009/'
        : 'https://chat.volt.link/'
    )
    const socket = io(url)


    socket.on('error', console.error.bind(console));
    // socket.on('response', ({ id, response, error }) => {
    //   messages.push({
    //     id,
    //     role: 'assistant',
    //     content: response || null,
    //     error: error || null,
    //   })
    //   display_messages()
    // })
    socket.on('partial_response', ({ id, response, error }) => {
      loading_node.classList.remove('active')

      const message_index = messages.findIndex(message => message.id === id)
      if (message_index === -1) {
        // create new message
        messages.push({
          id,
          role: 'assistant',
          content: response || null,
          error: error || null,
        })
      } else {
        // append to existing message by id
        messages[message_index].content += response
      }

      display_messages()
    })
  </script>
</body>

</html>
